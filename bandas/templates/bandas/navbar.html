{% load static %}
<style>
  .navbar-fixed-custom{position:fixed;top:0;left:0;right:0;z-index:1030}
  body{padding-top:70px}
  .navbar-nav{flex-wrap:wrap}
  .navbar .dropdown-menu{max-height:300px;overflow:auto;max-width:360px;white-space:normal}
  .search-results{position:absolute;display:none;background:#fff;border:1px solid #ddd;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,.15);z-index:1050;max-height:300px;overflow:auto;box-sizing:border-box;margin-top:6px}
  @media (max-width:576px){.search-results{width:160px}.navbar .form-control{width:160px}}
</style>

<nav class="navbar navbar-expand-lg bg-body-tertiary navbar-fixed-custom">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Bandas 2000s</a>

    <div class="d-flex align-items-center ms-auto me-2">
      <button id="themeToggle" class="btn btn-outline-secondary btn-sm" type="button" aria-label="Alternar tema">
        <span id="themeIcon">üåô</span>
      </button>
    </div>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu" aria-controls="navbarMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMenu">
      <form class="d-flex ms-auto mb-2 mb-lg-0 position-relative" role="search" onsubmit="return false;">
        <input id="navbarSearch" class="form-control me-2" type="search" placeholder="Buscar banda o √°lbum..." aria-label="Search" autocomplete="off" />
        <div id="searchResults" class="search-results list-group"></div>
      </form>

      <ul class="navbar-nav ms-auto mb-2 mb-lg-0" id="bandasMenu">
        {% for banda_id, banda in bandas.items %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown{{ forloop.counter }}" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            {{ banda.nombre }}
          </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown{{ forloop.counter }}">
            <li>
              <a class="dropdown-item fw-bold" href="{% url 'lista_albumes' banda_id %}">P√°gina de {{ banda.nombre }}</a>
            </li>
            <li><hr class="dropdown-divider"></li>
            {% for album_id, album in banda.albumes.items %}
            <li>
              <a class="dropdown-item" href="{% url 'lista_canciones' banda_id album_id %}">{{ album.nombre }}</a>
            </li>
            {% endfor %}
          </ul>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</nav>

<script>
(function(){
  const btn = document.getElementById('themeToggle');
  const icon = document.getElementById('themeIcon');
  const apply = (mode) => {
    if(mode === 'dark'){
      document.body.classList.add('dark-mode');
      icon.textContent = '‚òÄÔ∏è';
    } else {
      document.body.classList.remove('dark-mode');
      icon.textContent = 'üåô';
    }
  };
  const saved = localStorage.getItem('site-theme');
  if(saved) apply(saved);
  else {
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    apply(prefersDark ? 'dark' : 'light');
  }
  // toggle click
  btn.addEventListener('click', function(){
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('site-theme', isDark ? 'dark' : 'light');
    apply(isDark ? 'dark' : 'light');
  });
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function buildSearchIndex(){
  const data = [];
  document.querySelectorAll('#bandasMenu > .nav-item').forEach(item => {
    const bandName = item.querySelector('.nav-link').textContent.trim();
    const bandPage = item.querySelector('.dropdown-item.fw-bold')?.href || '#';
    const albums = [];
    item.querySelectorAll('.dropdown-item').forEach(a => {
      if(!a.classList.contains('fw-bold')){
        albums.push({name: a.textContent.trim(), href: a.href});
      }
    });
    data.push({band: bandName, page: bandPage, albums: albums});
  });
  return data;
}

document.addEventListener('DOMContentLoaded', function(){
  const index = buildSearchIndex();
  const input = document.getElementById('navbarSearch');
  const resultsBox = document.getElementById('searchResults');

  function renderResults(items){
    if(items.length === 0){ resultsBox.style.display='none'; resultsBox.innerHTML=''; return; }
  resultsBox.innerHTML = items.map(it => `\n      <a class="list-group-item list-group-item-action" href="${it.href}">${it.label}</a>\n    `).join('');
  const rect = input.getBoundingClientRect();
  resultsBox.style.width = Math.min(360, rect.width) + 'px';
  resultsBox.style.left = input.offsetLeft + 'px';
  resultsBox.style.top = (input.offsetTop + input.offsetHeight) + 'px';
  resultsBox.style.display = 'block';
  }

  function search(q){
    q = q.trim().toLowerCase();
    if(!q){ renderResults([]); return; }
    const out = [];
    index.forEach(b => {
      if(b.band.toLowerCase().includes(q)){
        out.push({label: b.band + ' ‚Äî p√°gina', href: b.page});
      }
      b.albums.forEach(al => {
        if(al.name.toLowerCase().includes(q)){
          out.push({label: b.band + ' ‚Ä∫ ' + al.name, href: al.href});
        }
      });
    });
    renderResults(out);
  }

  input.addEventListener('input', function(e){
    search(e.target.value);
  });

  document.addEventListener('click', function(e){
    if(!input.contains(e.target) && !resultsBox.contains(e.target)){
      resultsBox.style.display = 'none';
    }
  });
});
</script>